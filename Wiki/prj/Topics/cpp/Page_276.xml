<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="../helpproject.xsl" ?>
<topic template="Default" lasteditedby="Kot" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../helpproject.xsd">
  <title translate="true">Отладка ядра</title>
  <body>
    <header>
      <para style="margin-bottom:2px; margin-left:4px;"><anchor id="hdr" styleclass="Heading1"></anchor><text style="font-family:Verdana; font-size:10pt; font-weight:bold; color:#000000;" translate="true">Отладка ядра</text></para>
    </header>
    <para><table rowcount="1" colcount="1" style="width:100%; cell-padding:1px; cell-spacing:0px; page-break-inside:auto; border-width:0px; border-spacing:0px; cell-border-width:0px; border-style:none; background-color:#99ccff; head-row-background-color:none; alt-row-background-color:none;">
      <tr style="vertical-align:top">
        <td style="vertical-align:middle;">
          <para><text style="font-family:Verdana; font-size:8pt; font-style:italic; color:#000000;" translate="true">C++ Бъерн Страуструп</text></para>
        </td>
      </tr>
    </table></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; page-break-after:auto; tabstops:none;"></para>
    <para styleclass="Normal" style="text-align:center; margin-left:94px; line-height:1.0; background-color:#ffffff; page-break-after:auto; tabstops:none;"></para>
    <para styleclass="Normal" style="text-align:center; margin-left:94px; line-height:1.0; background-color:#ffffff; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Verdana; font-size:14pt; vertical-align:baseline; color:#000000;" translate="true">Хакер № 02/09 (122)</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:94px; line-height:1.0; background-color:#ffffff; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:17pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Виртуальная отладка. Отладка kernel mode кода с использованием VMware</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Артем Баранов</text></para>
    <para styleclass="Normal"><line style="height:1px; color:#000000;" /></para>
    <para styleclass="Normal" style="margin-top:10px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Отладка кода режима ядра существенно сложнее, чем отладка обычных программ. Если для отладки пользовательского кода ты можешь использовать стандартный дебаггер, например, в Visual Studio или в IDA, то для отладки кода режима ядра требуются спецсредства. Короче, без бутылки не разобраться. Равно, как и без этой статьи.</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Использование</text><text style="font-family:Tahoma; font-size:9pt; color:#000000;" translate="true">&#32;</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Windbg</text><text style="font-family:Tahoma; font-size:9pt; color:#000000;" translate="true">&#32;</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">в качестве средства для отладки предоставит большие возможности по исследованию драйверов, кода ядра и системных DLL. Применяя при этом VMware, процесс отладки можно сделать куда более простым и приятным (уж точно приятнее, чем тестирование драйвера на физической машине). С этими инструментами ты сможешь исследовать поведение системных компонентов также хорошо, как и своих драйверов.</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Сама идея трассирования кода ОС (в состав которой входят и драйверы) реализуется с помощью двух подходов: отладчик находится на той же машине, что и трассируемая ОС или отладчик установлен на другой машине (host), которая связана через порт с трассируемой ОС (target). Первый подход реализован в самом лучшем отладчике SoftICE, другой в</text><text style="font-family:Tahoma; font-size:9pt; color:#000000;" translate="true">&#32;</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Visual SoftICE</text><text style="font-family:Tahoma; font-size:9pt; color:#000000;" translate="true">&#32;</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">и</text><text style="font-family:Tahoma; font-size:9pt; color:#000000;" translate="true">&#32;</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Windbg</text><text style="font-family:Tahoma; font-size:9pt; color:#000000;" translate="true">&#32;</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">(они не менее хороши). Отладка кода на двух машинах мало кому представляется возможной, поэтому в большинстве случаев прибегают к помощи виртуальных машин, которые соединяют через pipe c host-системой.</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:94px; line-height:1.0; background-color:#ffffff; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:14pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Определяемся со средством</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Дам ответ на самый наболевший вопрос: какое средство выбрать для отладки. Compuware</text><text style="font-family:Tahoma; font-size:9pt; color:#000000;" translate="true">&#32;</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Visual SoftICE</text><text style="font-family:Tahoma; font-size:9pt; color:#000000;" translate="true">&#32;</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">или</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Windbg</text><text style="font-family:Tahoma; font-size:9pt; color:#000000;" translate="true">&#32;</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">– отчасти дело привычки, но выбор в сторону Windbg дает следующие преимущества:</text></para>
    <list id="1" level="1" type="ul" listtype="bullet" formatstring="&#111;" format-charset="RUSSIAN_CHARSET" levelreset="true" legalstyle="false" startfrom="1" styleclass="Normal" style="text-indent:-13px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none; font-family:&apos;Courier New&apos;; font-size:9pt; color:#000000;">
      <li styleclass="Normal" style="text-indent:-13px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Windbg является «родным» для NT средством.</text><text style="font-family:Tahoma; font-size:9pt; color:#000000;" translate="true">&#32;</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Windbg</text><text style="font-family:Tahoma; font-size:9pt; color:#000000;" translate="true">&#32;</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">разрабатывался Microsoft специально как отладчик любого кода под NT;</text></li>
      <li styleclass="Normal" style="text-indent:-13px; margin-top:6px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Windbg содержит множество команд расширений с осмысленной семантикой (поставляемых в стандартных библиотеках DLL расширений), которые упрощают отладку кода;</text></li>
      <li styleclass="Normal" style="text-indent:-13px; margin-top:6px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Удобный оконный интерфейс для отладки кода;</text></li>
      <li styleclass="Normal" style="text-indent:-13px; margin-top:6px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Удобная система рабочего пространства отлаживаемого кода (workspace ~ воркспейс);</text></li>
      <li styleclass="Normal" style="text-indent:-13px; margin-top:6px; margin-bottom:6px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Поддержка host-target отладки, в том числе и через VMware.</text></li>
    </list>
    <para styleclass="Normal" style="margin-left:94px; line-height:1.0; background-color:#ffffff; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:14pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Подготовка соединения</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Перед тем, как начать тестирование драйвера или трассирование (исследование) кода ядра, необходимо настроить соединение между отладчиком, который расположен в host-машине и target виртуальной машиной.</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Вначале настраивается target-машина. Первое, что необходимо сделать, это создать именованный канал для общения target-системы с host. Заходим в меню настроек виртуальной машины (Ctrl-D). Жмем на Add и выбираем Serial Port. В следующем окне надо выбрать Output to named pipe. Далее указываем имя пайпа (оставляем по умолчанию) и в двух списках выбираем This end is the server и The other end is an application, ставим галочку на Connect at power on. После того как пайп создался, поставь галочку на Yield CPU on poll.</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Теперь осталось настроить саму target-систему. Для этого необходимо загрузиться, открыть boot.ini и вписать туда еще одну строку. Вначале необходимо скопировать строку, с помощью которой загружается система, потом вставить ее и дописать к ней следующее содержание:</text><text style="font-family:Tahoma; font-size:9pt; color:#000000;" translate="true">&#32;</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">/debug /debugport=</text><text style="font-family:Courier; font-size:9pt; color:#005500; background-color:#f4f4f4;" translate="true">com1</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true"> /baudrate=</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">115200</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">.</text></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Пример файла boot.ini с такими параметрами может выглядеть так:</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">[boot loader]</text></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">timeout=</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">30</text></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">default=multi(</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">0</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">)disk(</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">0</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">)rdisk(</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">0</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">)partition(</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">1</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">)\WINDOWS</text></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">[operating systems]</text></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">multi(</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">0</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">)disk(</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">0</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">)rdisk(</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">0</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">)partition(</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">1</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">)\WINDOWS=</text><text style="font-family:Courier; font-size:9pt; color:#005500; background-color:#f4f4f4;" translate="true">&quot;Microsoft Windows XP Professional&quot;</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true"> /noexecute=optin /fastdetect /sos</text></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">multi(</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">0</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">)disk(</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">0</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">)rdisk(</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">0</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">)partition(</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">1</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">)\WINDOWS=</text><text style="font-family:Courier; font-size:9pt; color:#005500; background-color:#f4f4f4;" translate="true">&quot;Microsoft Windows XP Professional&quot;</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true"> /fastdetect /sos /debug /debugport=com1 /baudrate=</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">115200</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Загрузчик при считывании второй строки отобразит в квадратных скобках после имени системы надпись</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">&#32;</text><text style="font-family:Courier; font-size:9pt; color:#0000ee; background-color:#f4f4f4;" translate="true">[debugger enabled]</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">.</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">При отладке драйвера обычно используют checked build (проверочную) версию системы. Точнее, checked build не всей системы, а только двух файлов ntoskrnl и hal (соответствующие внутренние образы могут варьироваться в зависимости от параметров системы, например, много- или однопроцессорная, ACPI или нет). Почему следует использовать такую версию?</text></para>
    <list id="1" level="1" type="ul" listtype="bullet" formatstring="&#111;" format-charset="RUSSIAN_CHARSET" levelreset="true" legalstyle="false" startfrom="1" styleclass="Normal" style="text-indent:-13px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none; font-family:&apos;Courier New&apos;; font-size:9pt; color:#000000;">
      <li styleclass="Normal" style="text-indent:-13px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">В коде (ntoskrnl и hal) активированы макросы ASSERT, что позволяет сразу же выявлять множество ошибок при передаче функциям неверных аргументов/адресов</text></li>
      <li styleclass="Normal" style="text-indent:-13px; margin-top:6px; margin-bottom:6px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">В таком коде ассемблерные инструкции более понятны для исследования, так как при его компиляции была отключена оптимизация</text></li>
    </list>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Для загрузки виртуальной машины под проверочным выпуском необходимо получить исходные (внутренние) имена файлов ntoskrnl и hal. Это можно сделать, например, зайдя в свойства файла (скажем, ntoskrnl) -&gt; вкладка Version, Internal Name (внутреннее имя). После этого скачай с сайта Microsoft checked-версию NT, найди файлы с соответствующими внутренними именами и переименуй их – допустим, в hal.chk и ntoskrnl.chk. Затем скопируй их в SystemRoot\system32. И в конце добавь к необходимой строке в boot.ini</text><text style="font-family:Tahoma; font-size:9pt; color:#000000;" translate="true">&#32;</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">/KERNEL=ntoskrnl</text><text style="font-family:Courier; font-size:9pt; color:#005500; background-color:#f4f4f4;" translate="true">.chk</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true"> /HAL=hal</text><text style="font-family:Courier; font-size:9pt; color:#005500; background-color:#f4f4f4;" translate="true">.chk</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">. К примеру, так:</text></para>
    <para style="margin-top:6px; margin-left:79px; background-color:#fbfafa;"><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">multi(</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">0</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">)disk(</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">0</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">)rdisk(</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">0</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">)partition(</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">1</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">)\WINDOWS=</text><text style="font-family:Courier; font-size:9pt; color:#005500; background-color:#f4f4f4;" translate="true">&quot;Microsoft Windows XP Professional [Checked Build]&quot;</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true"> /fastdetect /sos /debug /debugport=com1 /baudrate=</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">115200</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true"> /KERNEL=ntoskrnl</text><text style="font-family:Courier; font-size:9pt; color:#005500; background-color:#f4f4f4;" translate="true">.chk</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true"> /HAL=hal</text><text style="font-family:Courier; font-size:9pt; color:#005500; background-color:#f4f4f4;" translate="true">.chk</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Теперь у тебя есть настроенная версия системы для отладки kernel mode кода. Учти, что на современных компьютерах работает DEP, а это значит, что загружается PAE-версия ядра, то есть образ ntkrnlpa. Убедиться в этом можно, просмотрев в разделе</text><text style="font-family:Tahoma; font-size:9pt; color:#000000;" translate="true">&#32;</text><text styleclass="Normal" style="font-family:Courier; font-size:9pt; vertical-align:baseline; color:#000000; background-color:#f4f4f4;" translate="true">HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">, параметр PhysicalAddressExtension.</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:94px; line-height:1.0; background-color:#ffffff; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:14pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Получение символов</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Для исследования кода ядра нужны символы – для правильного отображения идентификаторов вместо голых адресов переменных и функций. Вовсе необязательно сливать весь пакет с символами целиком (от 150 до 250 MB) с сайта Microsoft – ты можешь слить символьные файлы под конкретные файлы (например, под конкретную версию ntoskrnl). Это можно сделать двумя программами. Первая, входящая в</text><text style="font-family:Tahoma; font-size:9pt; color:#000000;" translate="true">&#32;</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Debugging Tools for Windows</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">, называется symchk. Не вдаваясь в подробности ключей (описания, которых можно найти в документации), ее можно использовать следующим образом.</text></para>
    <para style="margin-top:6px; margin-left:79px; background-color:#fbfafa;"><text style="font-family:Courier; font-size:9pt; color:#005500; background-color:#f4f4f4;" translate="true">&quot;c:\Program Files\Debugging Tools for Windows\symchk&quot;</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">&#32;</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">/r D:\Work\SymbolsShare\EXE\ /s</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true"> srv*D:\Work\SymbolStorage*http:</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">//msdl</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">.microsoft.co</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">m/download/symbols</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Соответственно, нужно указать правильный путь к установленной у тебя symchk. В директорию (она может быть любой) D:\Work\SymbolsShare\EXE\ ты скидываешь файлы, для которых необходимо получить символы. В папке D:\Work\SymbolStorage оказываются символы для файлов. Файлы из директорий в D:\Work\SymbolStorage необходимо скопировать в одну папку, в которую затем будет направлен поиск символов в windbg.</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Вторым способом является использование входящей в Compuware Driver Studio программы SymbolRetriver, которая обладает интуитивно понятным интерфейсом.</text></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Microsoft также предоставляет более гибкий способ управления символами – на основе symbols storage (хранилища символов): он полезен при работе с несколькими виртуальными машинами, на которых установлены разные версии NT, но также полезен и при работе с одной виртуальной машиной. Напрямую к хранилищу обращаться нельзя. Для этого предназначен сервер символов (symbol server), который и нужно вызывать для получения доступа к хранилищу. В хранилище могут содержаться произвольные идентификаторы (pdb-файлы), но при использовании сервера символов (стандартный symsrv.dll) Windbg (или dbghelp.dll) можно получить символьную информацию для нужного образа автоматически. Сервер символов позволяет отладчику самому получать корректные символьные файлы. Для его активации в каком-либо пути к символам нужно указать строку symsrv*symsrv.dll*CacheStore*Server (symsrv*symsrv.dll можно свернуть в srv, а если хранилище локальное, то – использовать srv*LocalPath). Самое удобное – указать эту строку в _NT_SYMBOL_PATH, которую используют библиотеки отладки. Если получать символы каждый раз через сервер Microsoft и кэшировать их в локальном хранилище (стандартный способ), то путь к символам может выглядеть так:</text></para>
    <para style="margin-top:6px; margin-left:79px; background-color:#fbfafa;"><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">srv*C:\storage*http:</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">//msdl</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">.microsoft.co</text><text style="font-family:Courier; font-size:9pt; color:#880000; background-color:#f4f4f4;" translate="true">m/download/symbols</text><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">.</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:94px; line-height:1.0; background-color:#ffffff; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:14pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Настройка интерфейса Windbg</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Понятие интерфейса Windbg входит в более широкое понятие воркспейса (workspace ~ рабочее пространство). В Windbg они бывают двух видов: по умолчанию и именованные (именованные также могут содержаться в файлах). Отладчик имеет несколько типов воркспейсов по умолчанию:</text></para>
    <list id="1" level="1" type="ul" listtype="bullet" formatstring="&#111;" format-charset="RUSSIAN_CHARSET" levelreset="true" legalstyle="false" startfrom="1" styleclass="Normal" style="text-indent:-13px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none; font-family:&apos;Courier New&apos;; font-size:9pt; color:#000000;">
      <li styleclass="Normal" style="text-indent:-13px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Базовый (base workspace). Используется, когда Windbg находится в бездействующем режиме, то есть код не отлаживается.</text></li>
      <li styleclass="Normal" style="text-indent:-13px; margin-top:6px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">По умолчанию для программ пользовательского режима (default user-mode workspace). Используется для отладки уже запущенных процессов, то есть когда отладчик присоединяется к уже работающему процессу.</text></li>
      <li styleclass="Normal" style="text-indent:-13px; margin-top:6px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">По умолчанию для режима ядра (default kernel-mode). Используется при старте сессии отладки для режима ядра.</text></li>
      <li styleclass="Normal" style="text-indent:-13px; margin-top:6px; margin-bottom:6px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Процессоро-зависимый (processor-specific workspace). Используется при отладке кода режима ядра при соединении к target-системе. Существуют раздельные воркспейсы для процессоров на базе x86, Itanium и x64.</text></li>
    </list>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Когда Windbg создает процесс пользовательского режима для отладки, воркспейс создается для исполняемого файла. Каждый отлаживаемый exe файл имеет свой воркспейс. Также, если происходит анализ дампа, то для каждого дампа создается своя сессия отладки (и свой воркспейс).</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Когда сессия отладки начинается, соответствующий проект загружается. По окончании сессии отладки windbg выводит окно с вопросом о сохранении воркспейса.</text></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Воркспейсы загружаются совокупно, то есть для одной сессии отладки загружается несколько воркспейсов. Первым загружается базовый воркспейс, так как в любом случае отладчик начинает свою работу в бездействующем режиме. Когда начинается конкретная сессия отладки, загружается второй воркспейс. Отладка кода режима ядра требует загрузки и третьего воркспейса (базовый, по умолчанию для кода режима ядра, процессоро-зависимый).</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Именованные воркспейсы могут использоваться для индивидуальной загрузки. Воркспейсы содержат важную информацию о текущем сеансе отладки – информацию о брейкпоинтах (включая их адреса и статусы), обработке исключений и событиях (эта информация загружается совокупно, начиная с базового воркспейса и заканчивая последним загруженным воркспейсом). Все открытые файлы с исходным кодом. Если такой файл не найден, выводится сообщение об ошибке.</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Воркспейсы сохраняют информацию о конфигурации отладчика. Эта информация также загружается совокупно, начиная с базового воркспейса и заканчивая последним загруженным воркспейсом.</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Все воркспейсы по умолчанию и именованные воркспейсы содержат информацию о графическом интерфейсе Windbg. Информация также загружается совокупно.</text></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">А вот следующая информация о GUI Windbg не загружается совокупно – она зависит от последнего загруженного воркспейса:</text></para>
    <list id="1" level="1" type="ul" listtype="bullet" formatstring="&#111;" format-charset="RUSSIAN_CHARSET" levelreset="true" legalstyle="false" startfrom="1" styleclass="Normal" style="text-indent:-13px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none; font-family:&apos;Courier New&apos;; font-size:9pt; color:#000000;">
      <li styleclass="Normal" style="text-indent:-13px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Размер и позиция окна Windbg на рабочем столе;</text></li>
      <li styleclass="Normal" style="text-indent:-13px; margin-top:6px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Какие окна Windbg открыты;</text></li>
      <li styleclass="Normal" style="text-indent:-13px; margin-top:6px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Размер и позиция каждого открытого окна, включая его размер, статус и является ли окно пристыкованным (dock) или плавающим (float);</text></li>
      <li styleclass="Normal" style="text-indent:-13px; margin-top:6px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Настройка окна регистров;</text></li>
      <li styleclass="Normal" style="text-indent:-13px; margin-top:6px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Флаги в окне вызовов (calls window);</text></li>
      <li styleclass="Normal" style="text-indent:-13px; margin-top:6px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Выражения в окне просмотра (watch window);</text></li>
      <li styleclass="Normal" style="text-indent:-13px; margin-top:6px; margin-bottom:6px; margin-left:136px; line-height:1.0; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Положение курсора в каждом окне исходников.</text></li>
    </list>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">При отладке программ в Windbg следует вначале настроить интерфейс главного окна – то есть положения окон – и сохранить это в воркспейсе по умолчанию. При отладке пользовательской программы Windbg создает конкретный, под ее exe-файл, проект, в котором можно несколько изменить положение окна, добавив в него файл(ы) с исходным кодом. Сюда же следует добавить брейкпоинты в (w)main и часто используемых (тестируемых) функциях. Тогда не нужно будет с нуля создавать положение окон для отладки новых программ, но в то же время, учитывая специфику отладки конкретной программы, можно добавить в ее воркспейс специфичную информацию, например, положение окна сырцов и брейкпоинты.</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">При отладке кода режима ядра все выглядит несколько смешанно. Так как для каждого отлаживаемого драйвера новый воркспейс не создается (он один для всей target-системы), то все брейкпоинты, положения окон, открытые файлы с сырцами будут делить один воркспейс.</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Для присоединения к VMware и отладке драйвера Windbg нужно запустить со следующими параметрами:</text></para>
    <para style="margin-top:6px; margin-left:79px; background-color:#fbfafa;"><text style="font-family:Courier; font-size:9pt; color:#000000; background-color:#f4f4f4;" translate="true">-k com:port=\\.\pipe\com_1,pipe.</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:94px; line-height:1.0; background-color:#ffffff; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:14pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Отладка</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">После того как все подготовительные меры были тобой предприняты, можно переходить к самой отладке. Загрузи NT в VMware в отладочном режиме. Когда часть драйверов будет загружена, ядро остановит свою работу в ожидании отладчика ядра (и будет ждать его подключения несколько минут). Если ты не подключишь отладчик в течение этого таймаута, система продолжит загружаться. Затем ты сможешь подключить отладчик или в момент продолжения загрузки, или уже во время ее работы.</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">После присоединения отладчика система либо продолжит выполняться под присмотром отладчика, либо сразу же отдаст ему управление (initial breakpoint). По умолчанию, система продолжает выполнение, но если необходимо, чтобы отладчик сразу же получил управление, используй в командной строке Windbg опцию –b.</text></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">По умолчанию стартовый брейкопинт пробуждает отладчик в функции</text><text style="font-family:Tahoma; font-size:9pt; color:#000000;" translate="true">&#32;</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">ExpInitializeExecutive</text><text style="font-family:Tahoma; font-size:9pt; color:#000000;" translate="true">&#32;</text><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">(уже после того, как выполнились DriverEntry boot драйверов). Для того чтобы в Windbg управление передалось сразу, как только это возможно (при инициализации HAL), используй параметр /break в boot.init. Так как инициализация HAL – это первое, что делает ядро, то данный брейкпоинт является первым из всех возможных (он генерируется в HalInitSystem -&gt; HalpGetParameter -&gt; DbgBreakPoint).</text></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Для отладки драйверов это имеет два важных последствия. Если тебе нужно отлаживать драйвер, параметр Start которого равен SERVICE_BOOT_START, то ты должен поставить в boot.ini параметр /break. Для остальных случаев подойдет стандартный подход (без /break). Просмотреть список загруженных образов ядра можно в меню Debug -&gt; Modules.</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Как только получишь управление в отладчик, тебе надо поставить брейкоинт на DriverEntry отлаживаемого драйвера (который еще не загружен), например, так: bp driver!DriverEntry, где driver – имя драйвера без расширения. Так как драйвер еще не загружен, то отладчик добавит брейкпоинт со статусом unresolved (список всех брейкпоинтов выводится по команде bl).</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Как только драйвер будет загружен и ядро передаст управление в его DriverEntry, вызовется отладчик, который сразу же должен отобразить соответствующий файл с исходным текстом (загружаемый драйвер в checked-варианте содержит путь к .pdb-файлу и Windbg вполне способен его прочесть). Если окно с сырцом не появилось, то посмотри, во-первых, checked ли версию драйвера ты загружаешь, во-вторых, установлен ли переключатель работы отладчика в режиме сырцов (выполни команду l+t). Если это все есть, то укажи Windbg, где ему искать символы (команда .sympath+ Path или меню File -&gt; Symbol File Path), а затем выполни команду .reload driver_name, где driver_name – имя драйвера с расширением.</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">После того как код отобразился, ты увидишь, что фигурная скобка начала функции подсвечивается. Поставить другие брейкпоинты можно, передвигаясь по файлу и ставя брейкоинты «ладошкой» на панели инструментов (F9). Windbg переключается из режима сырцов в asm режим, когда ты переходишь в окно disassembly. Здесь также можно ставить брейкоинты на голых инструкциях. Чтобы поставить брейкпоинт в сырцах из окна команд, используй синтаксис bp `src_file:line_num`, где src_file – исходный файл с расширением и line_num – номер строки, на которую нужно поставить брейкпоинт. Либо, если есть голый адрес, – использовать bp addr. Чтобы открыть визуальное окно брейкпоинтов, нужно переместить фокус в окно команд и нажать &lt;F9&gt;. После расстановки брейкпоинтов, чтобы дать системе продолжить выполнение, можно нажимать &lt;F5&gt; (g в окне команд).</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Для работы с отладчиком необходимо, чтобы само ядро на target-машине отдало ему управление и работало с ним. В режиме, когда ты нажал &lt;F5&gt;, и в окне команд высветилось Debuggee is running…, никакое окно отладчика не будет давать правильную информацию. Брейкопинты также будет ставить нельзя и нельзя добавлять выражения в Watch-окно. Чтобы target-систему передала управление на отладчик, нужно нажать на панели управления Break (или нажать s&lt;Ctrl+Break&gt;). Тогда отладчик получит управление над target-системой.</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Отладка на основе host-target может быть очень полезна при отладке сервисов, которые нельзя отлаживать без ограничений локальным отладчиком. Windbg через VMware предоставляет возможность полного контроля над отлаживаемым сервисом. Если появилась необходимость в отладке службы, то вставь в ее стартовую функцию вызов DebugBreak. Единственное его предназначение – выполнить int 0x3. Но так как диспетчер исключений предоставляет отладчику ядра первому обработать исключение, то управление будет передано напрямую в подключенный Windbg.</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:94px; line-height:1.0; background-color:#ffffff; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:14pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">И это все?!</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Поздравляю, коллега. Только что ты научился работать с kernel mode кодом, используя лишь Windbg и VmWare. Но нет предела совершенству – как нет пределов изучению новых отладочных технологий. Их я непременно освещу в ближайших номерах твоего любимого журнала.</text></para>
    <para styleclass="Normal" style="text-align:center; margin-top:6px; margin-bottom:6px; margin-left:79px; line-height:1.0; page-break-after:auto; tabstops:none;"><link displaytype="text" defaultstyle="true" type="weblink" href="http://www.xakep.ru/magazine/xa/122/" styleclass="Normal" style="font-family:Tahoma; font-size:8pt; vertical-align:baseline; color:#000000;" translate="true">Содержание</link><text styleclass="Normal" style="font-family:Verdana; font-size:8pt; vertical-align:baseline; color:#000000;" translate="true"> &#160;</text></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; page-break-after:auto; tabstops:none;"><anchor id="VIDEO" style="font-family:Arial; font-size:10pt; color:#000000;"></anchor></para>
    <para styleclass="Normal" style="margin-left:94px; line-height:1.0; background-color:#ffffff; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:14pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">ВИДЕО К ЭТОМУ НОМЕРУ</text></para>
    <para styleclass="Normal" style="margin-top:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><link displaytype="text" defaultstyle="true" type="weblink" href="http://www.xakep.ru/post/49049/" styleclass="Normal" style="font-family:Tahoma; font-size:9pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Смертельная связка</link></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">в этом ролике ты узнаешь, как гонят трафик со взломанных хостов. сначала хакер устанавливает на одном из забугорных серверов связку сплойтов, а затем использует заранее залитый веб-шелл для вставки ...-кода в контент на чужом сервере....</text></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><link displaytype="text" defaultstyle="true" type="weblink" href="http://www.xakep.ru/post/48903/" styleclass="Normal" style="font-family:Tahoma; font-size:9pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Легче не бывает</link></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Для построения сервиса администраторы предпочитают выбирать решение, с которым приходилось иметь дело ранее или наиболее известное - Apache, Squid, BIND, Postfix, Courier Mail Server. Но не всегда проторенный путь является оптимальным, о...</text></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><link displaytype="text" defaultstyle="true" type="weblink" href="http://www.xakep.ru/post/48844/" styleclass="Normal" style="font-family:Tahoma; font-size:9pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Играем бесплатно</link></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Скачиваемые мини-игры победно шествуют по миру развлечений, много людей играют в них, но... Они стоят денег! Система триала у них такая: 60 минут халявы, а за все остальное - отправляй смс-ку! Стоит смс-ка 3$, что устраивает далеко не вс...</text></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><link displaytype="text" defaultstyle="true" type="weblink" href="http://www.xakep.ru/post/48771/" styleclass="Normal" style="font-family:Tahoma; font-size:9pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Гиперактивная виртуальность</link></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Hyper-V - мощное средство виртуализации, обладающее высокой производительностью и масштабируемостью. Поставляется как компонент некоторых версий операционной системы Windows Server 2008 и работает только на 64 битных процессорах. В этом...</text></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"></para>
    <para styleclass="Normal" style="margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><link displaytype="text" defaultstyle="true" type="weblink" href="http://www.xakep.ru/post/48688/" styleclass="Normal" style="font-family:Tahoma; font-size:9pt; font-weight:bold; vertical-align:baseline; color:#000000;" translate="true">Крушим Facebook.com</link></para>
    <para styleclass="Normal" style="margin-bottom:6px; margin-left:79px; line-height:1.0; background-color:#fbfafa; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Tahoma; font-size:9pt; vertical-align:baseline; color:#000000;" translate="true">Ролик демонстрирует наличие уязвимостей класса SQL-injection в одной из крупнейших социальных сетей мира Facebook. Правда, основные ошибки, с помощью которых был осуществлен основной взлом, внимательные админы устранили практически момен...</text></para>
    <para styleclass="Normal"><line style="height:1px; color:#999999;" /></para>
    <para styleclass="Normal" style="margin-top:10px; margin-bottom:6px; line-height:1.0; page-break-after:auto; tabstops:none;"><text styleclass="Normal" style="font-family:Verdana; font-size:8pt; font-style:italic; vertical-align:baseline; color:#000000;" translate="true"> Copyright ©2013 </text><text styleclass="Normal" style="font-family:Verdana; font-size:8pt; font-style:italic; vertical-align:baseline; color:#0000ff;" translate="true">C++</text><text styleclass="Normal" style="font-family:Verdana; font-size:8pt; font-style:italic; vertical-align:baseline; color:#000000;" translate="true">. All Rights Reserved.</text></para>
  </body>
</topic>
